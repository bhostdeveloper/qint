qmail-smtpd(8)                                                  qmail-smtpd(8)



NNAAMMEE
       qmail-smtpd - receive mail via SMTP

SSYYNNOOPPSSIISS
       qqmmaaiill--ssmmttppdd [ _h_o_s_t_n_a_m_e _c_h_e_c_k_p_r_o_g_r_a_m _s_u_b_p_r_o_g_r_a_m ]

DDEESSCCRRIIPPTTIIOONN
       qqmmaaiill--ssmmttppdd  receives mail messages via the Simple Mail Transfer Proto‐
       col (SMTP) and invokes qqmmaaiill--qquueeuuee to deposit them  into  the  outgoing
       queue.  qqmmaaiill--ssmmttppdd must be supplied several environment variables; see
       ttccpp--eennvviirroonn((55)).

       qqmmaaiill--ssmmttppdd is responsible for counting hops.  It rejects  any  message
       with 100 or more RReecceeiivveedd or DDeelliivveerreedd--TToo header fields.

       qqmmaaiill--ssmmttppdd  has  been  modified to include many capabilities which are
       not present in a standard qmail  installation.  The  modifications  are
       briefly  described  below,  or you can visit the web page listed at the
       end of this document for a more complete description of how  this  ver‐
       sion of qmail-smtpd differs from the standard qmail-smtpd.

       qqmmaaiill--ssmmttppdd  supports  ESMTP,  including  the 8BITMIME, PIPELINING, and
       AUTH options.

       qqmmaaiill--ssmmttppdd can accept  LOGIN,  PLAIN,  and  optionally  CRAM-MD5  AUTH
       types.   It  invokes _c_h_e_c_k_p_r_o_g_r_a_m, which reads on file descriptor 3 the
       username, a 0 byte, the password  or  CRAM-MD5  response  derived  from
       _h_o_s_t_n_a_m_e,  another  0  byte, a CRAM-MD5 challenge (if applicable to the
       AUTH type), and a final 0 byte.  _c_h_e_c_k_p_r_o_g_r_a_m invokes  _s_u_b_p_r_o_g_r_a_m  upon
       successful  authentication,  which  should  in  turn return 0 to qqmmaaiill--
       ssmmttppdd, effectively setting the environment  variables  RELAYCLIENT  and
       TCPREMOTEINFO (any supplied value replaced with the authenticated user‐
       name).  qqmmaaiill--ssmmttppdd  will  reject  the  authentication  attempt  if  it
       receives a nonzero return value from _c_h_e_c_k_p_r_o_g_r_a_m or _s_u_b_p_r_o_g_r_a_m.

TTRRAANNSSPPAARREENNCCYY
       qqmmaaiill--ssmmttppdd  converts the SMTP newline convention into the UNIX newline
       convention by converting CR LF into LF.  It returns a  temporary  error
       and      drops      the     connection     on     bare     LFs;     see
       hhttttpp::////ppoobbooxx..ccoomm//~~ddjjbb//ddooccss//ssmmttppllff..hhttmmll.

       qqmmaaiill--ssmmttppdd accepts messages that contain long lines or non-ASCII char‐
       acters, even though such messages violate the SMTP protocol.

CCOONNTTRROOLL FFIILLEESS
       _b_a_d_h_e_l_o
            Unacceptable  HELO/EHLO host names.  qqmmaaiill--ssmmttppdd will reject every
            recipient address for a message if the host name is listed in,  or
            matches a POSIX regular expression pattern listed in, _b_a_d_h_e_l_o.  If
            the NNOOBBAADDHHEELLOO environment variable is set, then  the  contents  of
            _b_a_d_h_e_l_o  will be ignored.  If the LLOOGGRREEGGEEXX environment variable is
            set, then the log entry generated by a match will include the reg‐
            ular  expression  which was matched.  For more information, please
            have a look at doc/README.qregex.

       _b_a_d_m_a_i_l_f_r_o_m
            Unacceptable envelope sender addresses.  qqmmaaiill--ssmmttppdd  will  reject
            every  recipient  address  for  a  message  if the envelope sender
            address is listed in, or matches a POSIX regular  expression  pat‐
            tern  listed in, _b_a_d_m_a_i_l_f_r_o_m.  A line in _b_a_d_m_a_i_l_f_r_o_m may be of the
            form @@_h_o_s_t, meaning every address at _h_o_s_t.  If the LLOOGGRREEGGEEXX  envi‐
            ronment  variable  is set, then the log entry generated by a match
            will include the regular expression which was matched.   For  more
            information, please have a look at doc/README.qregex.

       _b_a_d_m_a_i_l_f_r_o_m_n_o_r_e_l_a_y
            Functions  the  same  as  the _b_a_d_m_a_i_l_f_r_o_m control file but is read
            only if the RREELLAAYYCCLLIIEENNTT environment variable is not set.  For more
            information, please have a look at doc/README.qregex.

       _b_a_d_r_c_p_t_t_o
            Unacceptable   envelope  recipient  addresses.   qqmmaaiill--ssmmttppdd  will
            reject every recipient address for  a  message  if  the  recipient
            address  is  listed in, or matches a POSIX regular expression pat‐
            tern listed in, _b_a_d_r_c_p_t_t_o.  If the LLOOGGRREEGGEEXX  environment  variable
            is  set,  then the log entry generated by a match will include the
            regular expression  which  was  matched.   For  more  information,
            please have a look at doc/README.qregex.

       _b_a_d_r_c_p_t_t_o_n_o_r_e_l_a_y
            Functions  the same as the _b_a_d_r_c_p_t_t_o control file but is read only
            if the RREELLAAYYCCLLIIEENNTT environment variable is not set (and the client
            has  not  done  a successful AUTH command.)  For more information,
            please have a look at doc/README.qregex.

       _d_a_t_a_b_y_t_e_s
            Maximum number of bytes allowed in a message, or 0 for  no  limit.
            Default:  0.  If a message exceeds this limit, qqmmaaiill--ssmmttppdd returns
            a permanent error code to the client; in contrast, if the disk  is
            full  or  qqmmaaiill--ssmmttppdd hits a resource limit, qqmmaaiill--ssmmttppdd returns a
            temporary error code.

            _d_a_t_a_b_y_t_e_s counts bytes as  stored  on  disk,  not  as  transmitted
            through  the  network.  It does not count the qqmmaaiill--ssmmttppdd Received
            line, the qqmmaaiill--qquueeuuee Received line, or the envelope.

            If  the  environment  variable  DDAATTAABBYYTTEESS  is  set,  it  overrides
            _d_a_t_a_b_y_t_e_s.   In  addition,  the environment variable is re-checked
            after a successful AUTH command, which makes it possible to change
            its value using an AUTH_SET_DATABYTES environment variable.

       _l_o_c_a_l_i_p_h_o_s_t
            Replacement  host  name  for  local IP addresses.  Default: _m_e, if
            that is supplied.  qqmmaaiill--ssmmttppdd is responsible for recognizing dot‐
            ted-decimal addresses for the current host.  When it sees a recip‐
            ient address of the form _b_o_x_@_[_d_._d_._d_._d_], where _d_._d_._d_._d is  a  local
            IP  address, it replaces _[_d_._d_._d_._d_] with _l_o_c_a_l_i_p_h_o_s_t.  This is done
            before _r_c_p_t_h_o_s_t_s.

       _m_a_x_r_c_p_t
            If this file exists and contains  a  non-zero  value,  qmail-smtpd
            will not accept more than this number of recipients for any single
            message.

            This value may be overridden using the MMAAXXRRCCPPTT  environment  vari‐
            able,  which  may  itself  be changed in the event of a successful
            AUTH command using an AAUUTTHH__SSEETT__MMAAXXRRCCPPTT environment variable.

       _m_f_c_h_e_c_k
            If this file exists and contains a non-zero value, the  MAIL  FROM
            argument  will be checked to make sure that the domain portion has
            an MX record. This can help prevent spammers  using  bogus  return
            addresses.  If  the  value  is greater than 1, the results of this
            check will be logged.

            If the environment variable MMFFCCHHEECCKK is set,  its  value  overrides
            the  value  in this file. In addition, the environment variable is
            re-checked  after  a  successful  AUTH  command,  which  makes  it
            possible to change its value using an AUTH_SET_MFCHECK environment
            variable.

       _m_o_r_e_r_c_p_t_h_o_s_t_s
            Extra allowed RCPT domains.  If _r_c_p_t_h_o_s_t_s and  _m_o_r_e_r_c_p_t_h_o_s_t_s  both
            exist, _m_o_r_e_r_c_p_t_h_o_s_t_s is effectively appended to _r_c_p_t_h_o_s_t_s.

            You must run qqmmaaiill--nneewwmmrrhh whenever _m_o_r_e_r_c_p_t_h_o_s_t_s changes.

            Rule  of  thumb  for  large  sites: Put your 50 most commonly used
            domains into _r_c_p_t_h_o_s_t_s, and the rest into _m_o_r_e_r_c_p_t_h_o_s_t_s.

       _r_c_p_t_h_o_s_t_s
            Allowed RCPT domains.  If _r_c_p_t_h_o_s_t_s is supplied, qqmmaaiill--ssmmttppdd  will
            reject  any envelope recipient address with a domain not listed in
            _r_c_p_t_h_o_s_t_s.

            Exception: If the environment variable RREELLAAYYCCLLIIEENNTT is set,  qqmmaaiill--
            ssmmttppdd  will  ignore _r_c_p_t_h_o_s_t_s, and will append the value of RREELLAAYY‐‐
            CCLLIIEENNTT to each incoming recipient address.

            _r_c_p_t_h_o_s_t_s may include wildcards:

               heaven.af.mil
               .heaven.af.mil

            Envelope recipient addresses without @ signs  are  always  allowed
            through.

       _s_m_t_p_g_r_e_e_t_i_n_g
            SMTP  greeting  message.  Default: _m_e, if that is supplied; other‐
            wise qqmmaaiill--ssmmttppdd will refuse to run.  The first word of _s_m_t_p_g_r_e_e_t_‐
            _i_n_g should be the current host’s name.

            Note  that this value can be overridden by setting an SSMMTTPPGGRREEEETTIINNGG
            eennvviirroonnmmeenntt vvaarriiaabbllee..

       _s_p_f_b_e_h_a_v_i_o_r
            Set to a value between 1 and 6 to enable SPF checks; 0 to disable.
            1  selects  ’annotate-only’  mode, where qqmmaaiill--ssmmttppdd will annotate
            incoming email with RReecceeiivveedd--SSPPFF fields, but will not  reject  any
            messages.   2  will produce temporary failures on DNS lookup prob‐
            lems so you can make sure you always have meaningful  Received-SPF
            headers.   3  selects  ’reject’  mode, where incoming mail will be
            rejected if the SPF record says ’fail’.  4 selects a more stricter
            rejection  mode, which is like ’reject’ mode, except that incoming
            mail will also be rejected when the SPF record says ’softfail’.  5
            will  also  reject when the SPF record says ’neutral’, and 6 if no
            SPF records are available at all (or a syntax  error  was  encoun‐
            tered).  The  contents of this file are overridden by the value of
            the SSPPFFBBEEHHAAVVIIOORR environment variable, if set.  Default: 0.

            Note that the environment variable is re-checked after a  success‐
            ful  AUTH  command,  which  makes  it possible to change its value
            using an AUTH_SET_SPFBEHAVIOR environment variable.

       _s_p_f_e_x_p
            You can add a line with a an SPF explanation that will be shown to
            the  sender in case of a reject. It will override the default one.
            You can use SPF macro expansion.

       _s_p_f_g_u_e_s_s
            You can add a line with SPF rules that will be checked if a sender
            domain  doesn’t  have  a  SPF record. The local rules will also be
            used in this case.

       _s_p_f_r_u_l_e_s
            You can add a line with SPF rules  that  will  be  checked  before
            other SPF rules would fail.  This can be used to always allow cer‐
            tain machines to send certain mails.

       _s_e_r_v_e_r_c_e_r_t_._p_e_m
            This file should contain a PEM-encoded key and  certificate  which
            will  be  used in order to create the server end of an SSL connec‐
            tion when processing the STARTTLS command.  This  file  should  be
            readable by qqmmaaiill--ssmmttppdd but not readable to the entire world.

            Note   that   this   filename  may  be  overridden  by  setting  a
            TTLLSS__SSEERRVVEERR__CCEERRTT eennvviirroonnmmeenntt vvaarriiaabbllee..

       _t_i_m_e_o_u_t_s_m_t_p_d
            Number of seconds qqmmaaiill--ssmmttppdd will wait for  each  new  buffer  of
            data from the remote SMTP client.  Default: 1200.


       EENNVVIIRROONNMMEENNTT VVAARRIIAABBLLEESS
              There  are  several  environment  variables  which may be set in
              order to modify how qmail-smtpd works.

       _A_L_L_O_W___C_R_A_M
            The CRAM-MD5 authentication  method  is  not  normally  supported,
            because  it requires the server to have a list of plain-text pass‐
            words.  TThhiiss iiss aa bbaadd tthhiinngg..  However, if you understand the prob‐
            lem and are willing to accept the risk that somebody cracking into
            your server might get all of your mailbox passwords  very  easily,
            you can set this variable to a non-zero value and qqmmaaiill--ssmmttppdd will
            advertise and support CRAM-MD5 as an authentication method.

            This option also requires that your checkpassword program know how
            to process a CRAM authentication request. The vvcchhkkppww program, part
            of the vpopmail package (version 5.4 and above) is able to  handle
            CRAM-MD5  if  you  compile  it with the option to store plain-text
            passwords. Earlier versions of vpopmail had a  bug  where  it  was
            reading the challenge and response in the wrong order, because the
            original SMTP AUTH patch sent the values in the wrong  order.  The
            66cc  version  of  the  combined patch (described at the end of this
            document) fixed the order.

       _A_L_L_O_W___I_N_S_E_C_U_R_E___A_U_T_H
            The AUTH command is not normally advertised  in  response  to  the
            EHLO  command,  or accepted from the client, unless the connection
            is known to be secure (because STARTTLS has been successfully pro‐
            cessed,  or  because  the  SSSSLL environment variable has a non-zero
            value.) Setting AALLLLOOWW__IINNSSEECCUURREE__AAUUTTHH to a non-zero value will  make
            qqmmaaiill--ssmmttppdd  advertise the AUTH capabilities in the EHLO response,
            and accept the AUTH command from the client, regardless of whether
            or not the connection is secure.

            TThhiiss  iiss  aa  vveerryy  bbaadd iiddeeaa..  This allows your users to send their
            passwords across the Internet in plain  text  when  they  AUTH  in
            order  to relay outbound mail. Anybody with a packet sniffer could
            get your user’s password, and then have their way with the  user’s
            mailbox,  or  anything  else  where the user may be using the same
            password. They would also be able to use that password to use your
            server as a relay for spam...

       _A_U_T_H___C_D_B
            If  present,  this  variable contains the name of a cdb file which
            contains valid userid/password combinations to  satisfy  the  AUTH
            command.  Each  key  in this file should be a valid system userid,
            virtual email address, or other value which passes for a  "userid"
            in  the  AUTH  command. The value linked to each key should be the
            ENCRYPTED password for that userid.

            Note that the passwords in this file MUST BE  ENCRYPTED  using  an
            encryption  or  hashing method supported by your system’s ccrryypptt((33))
            function. This is almost always the same set of encryption methods
            used for the system’s password database.

       _A_U_T_H___S_E_T__ _a_n_d _A_U_T_H___U_N_S_E_T__
            When the first DATA command is sent during a session, if any envi‐
            ronment variables with names like  AUTH_SET_{something}  exist,  a
            corresponding environment variable called {something} will be cre‐
            ated with the value from the AUTH_SET_{something} variable, or  if
            such  a  variable  already  exists,  the  existing  value  will be
            replaced with the new value. In either case,  the  AUTH_SET_{some‐
            thing} variable will then be deleted.

            At  the  same  time,  if any environment variables with names like
            AUTH_UNSET_{something} exist, any  existing  environment  variable
            called  {something} will be deleted from the environment, and then
            the AUTH_UNSET_{something} variable will be deleted.

            These types of variables can be useful in situations where changes
            need  to be made to the environment when a user successfully sends
            an AUTH command, in order to modify  the  behavior  of  a  program
            called through the QQMMAAIILLQQUUEEUUEE mechanism (see below.)

       _D_E_N_Y___T_L_S
            Setting  this  variable to a non-zero value will cause qmail-smtpd
            to not support the STARTTLS command under any circumstances.

            This value is internally set to 1 if  the  sseerrvveerrcceerrtt..ppeemm  control
            file (or whatever filename the TTLLSS__SSEERRVVEERR__CCEERRTT variable points to)
            is not present or not readable.

       _D_R_O_P___P_R_E___G_R_E_E_T
            Many spammers will try to send commands to SMTP servers before the
            server has sent its inital greeting, even though this violates RFC
            821. Setting this variable to a non-zero value will cause to pause
            for  one  second before sending the initial greeting, and drop any
            client connection which tries to send commands before the greeting
            has been sent.

            Note  that if you also use the GGRREEEETTDDEELLAAYY variable, the one second
            delay that DROP_PRE_GREET uses is taken from that number-  so  the
            value of GREETDELAY will be the total used by both features.

       _F_O_R_C_E___T_L_S
            Setting  this  variable to a non-zero value will cause qqmmaaiill--ssmmttppdd
            not to accept the MAIL FROM command unless STARTTLS has been  suc‐
            cessfully  processed.  This  makes  it  possible to create an SMTP
            server which can only be used by authorized users.

            WWAARRNNIINNGG:: ddoo nnoott ddoo tthhiiss ffoorr aa ssttaannddaarrdd ppoorrtt 2255 SSMMTTPP sseerrvviiccee  which
            handles  incoming  mail  for any real domains, or you will prevent
            the domain from being able to receive any mail unless  it  happens
            to come from one of your authorized users.

            This  value is internally set to zero if the SSSSLL environment vari‐
            able is set to a non-zero value.

            If you try to combine FFOORRCCEE__TTLLSS with DDEENNYY__TTLLSS (either by  manually
            setting  the  DDEENNYY__TTLLSS  variable,  or  by  not  having  a readable
            sseerrvveerrcceerrtt..ppeemm control file) the client will receive an error mes‐
            sage  and qqmmaaiill--ssmmttppdd will exit without accepting any message from
            the client.

       _G_R_E_E_T_D_E_L_A_Y
            Many spammers use programs which will give up on an SMTP server if
            the server answers but doesn’t send its initial banner in a timely
            manner. However, legitimate mail servers will wait for the banner.
            If  you  set  this  variable to a non-zero value, qqmmaaiill--ssmmttppdd will
            pause that many seconds before sending the banner.

            Note that if you also use the DDRROOPP__PPRREE__GGRREEEETT variable,  the  extra
            one-second delay that DROP_PRE_GREET introduces is taken from this
            total, so that if both variables are used, the value of GREETDELAY
            is the total delay introduced by both features.

       _L_O_G_R_E_G_E_X
            The badhelo, badmailfrom, badmailfromnorelay, badrcptto, and badr‐
            cpttonorelay control files contain regular expressions which  will
            cause HELO, MAIL FROM, or RCPT TO commands whose arguments match a
            pattern listed in the file to be rejected.

            If this variable exists, the log messages generated by these  mec‐
            ahnisms will include the regular expression which was matched.

       _M_A_X_R_C_P_T
            If  this  variable  is set, its value will override the value from
            the mmaaxxrrccpptt control file. It sets the maximum number of recipients
            for any one message.

            This variable is re-checked after a successful AUTH command, which
            makes it possible to change its value  using  an  AUTH_SET_MAXRCPT
            environment variable.

       _M_F_C_H_E_C_K
            If  this  variable  is set and has a non-zero value, the MAIL FROM
            argument will be checked to make sure that the domain portion  has
            an  MX  record.  This can help prevent spammers using bogus return
            addresses. Note that this is the same check which is done  if  the
            control  file contains a non-zero value, although the value in the
            environment variable overrides the value in the file.

            If the value is greater than 1, the results of this check will  be
            logged.

            This variable is re-checked after a successful AUTH command, which
            makes it possible to change its value  using  an  AUTH_SET_MFCHECK
            environment variable.

       _P_A_S_S_W_O_R_D___E_X_P_I_R_E_S
            If  this  variable is set, it is expected to contain a unix time()
            value (the number of seconds since 1970-01-01  00:00:00  GMT.)  If
            the  current time is equal to or greater than this value, any AUTH
            command will fail with an error message saying that  the  password
            is expired.

            Logically,  this variable should only be used on a per-user basis.
            The AUTH_CDB patch allows  you  to  create  environment  variables
            which  are  created  when  a specific user sends a successful AUTH
            command. Otherwise, there is currently no other way to set this on
            a per-user basis.

       _Q_M_A_I_L_Q_U_E_U_E
            If  this  variable is set, it should point to a program which will
            be executed instead of the qqmmaaiill--qquueeuuee program, in order to add  a
            received  message to the queue. This program should read its input
            and return the values exactly as the original qqmmaaiill--qquueeuuee  program
            does.  This version of the patch adds two additional return values
            which are not present in the original qqmmaaiill--qquueeuuee program:

            11    Tells the remote SMTP client "Your spam  has  been  ignored",
                 with  the  same  status  code  as a successful delivery. This
                 tells the remote SMTP client that the message was  delivered,
                 while  in  fact  the message was not added to the queue. This
                 can be used in cases where you know the message is  SPAM  and
                 you  know  that  if  you  refuse the message, the remote SMTP
                 client is only going to keep trying over and over.

            3322   Tells the remote SMTP client "we do not accept SPAM", with  a
                 status code indicating permanent refusal of the message (i.e.
                 a "hard error".) This can be used if you know that  the  mes‐
                 sage  is  SPAM and want this message to show up in the remote
                 server’s log (instead of the  standard  "mail  server  perma‐
                 nently rejected message" caused by return value 31.)

       _R_C_P_T_C_H_E_C_K
            If  this variable exists, it should contain the full pathname to a
            program which qqmmaaiill--ssmmttppdd will run after receiving each RRCCPPTT  com‐
            mand.

            No  arguments  are  passed on the command line; before running the
            program, qqmmaaiill--ssmmttppdd will store the recipient address sent by  the
            client  in  the  RREECCIIPPIIEENNTT  environment  variable,  and the sender
            address (from the MMAAIILL command) in the SSEENNDDEERR variable. Any  other
            environment variables which were present when qqmmaaiill--ssmmttppdd started,
            as possibly modified by the AAUUTTHH__SSEETT mechanism, will be present as
            well.  Note  that  this  includes the TTCCPPRREEMMOOTTEEIIPP variable, set by
            tcpserver, which will contain the client’s IP address.

            The exit code of the program determines whether or not qqmmaaiill--ssmmttppdd
            will accept the command. The possible values are:

            110000  The  recipient is not valid. The client receives a 553 error.

            111111  Temporary  problem  verifying  the  recipient.   The   client
                 receives a 421 error code and the connection is closed.

            112200  The  program could not execute correctly. The client receives
                 a 421 error code and the connection is closed.

            aannyytthhiinngg eellssee
                 The recipient is valid.

            Anything the program may send to  its  standard  out  or  standard
            error  channel will be sent to the SMTP service’s logs, just as if
            qqmmaaiill--ssmmttppdd had printed it. This allows your program to  log  what
            it’s doing.

            This  variable may be modified using the AAUUTTHH__SSEETT mechanism if you
            want to bypass recipient checking, or use a different program, for
            clients  who  have sent a valid AUTH command. However, I recommend
            you write  your  program  to  check  the  SSMMTTPP__AAUUTTHH__UUSSEERR  variable
            instead- if a valid AUTH command has been sent, this variable will
            contain the userid from that command.

            This functionality (calling an external program in response to  an
            AUTH  command)  comes  from  Jay Soffian’s RCPTCHECK patch, and is
            more fully documented on his web site:

                   http://www.soffian.org/downloads/qmail/qmail-smtpd-doc.html


       _R_E_L_A_Y_C_L_I_E_N_T
            If  this  variable exists when qqmmaaiill--ssmmttppdd starts, the remote SMTP
            client will be allowed to relay mail, ignoring the  rrccpptthhoossttss  and
            mmoorreerrccpptthhoossttss..ccddbb  files.  This  is  normally  only  done  for  IP
            addresses which belong to you or your clients, and which could not
            be  used  by  anybody  who should not be authorized to relay. Some
            sites don’t use this at all, preferring to grant relay access only
            to users who send a successful AUTH command.

       _R_E_L_A_Y_R_E_J
            If this variable exists and has a non-zero value, qqmmaaiill--ssmmttppdd will
            do a sanity check each  recipient  address,  to  ensure  that  the
            address  does not contain multiple "@" characters, or that it does
            not contain any "%" or "!" characters before the "@" character.

            This check is only useful when dealing with broken  relay  testers
            that  try to use these characters to trigger old sendmail bugs and
            force your server to be  an  open  relay.  Without  these  checks,
            qmail-smtpd  may  accept  messages but then not be able to deliver
            them- however some broken relay testers consider this to  be  evi‐
            dence of an open relay.

            This  check  is normally not needed, and in fact it can break some
            types of gateway systems (such  as  SMTP-to-UUCP.)  However,  some
            people  seem  to  get  a warm fuzzy feeling if they know that it’s
            being done, so I’ve included it for their benefit.   PPlleeaassee  ddoonn’’tt
            uussee iitt..

            This variable is re-checked after a successful AUTH command, which
            makes it possible to change its value using  an  AUTH_SET_RELAYREJ
            environment variable.

       _R_E_Q_U_I_R_E___A_U_T_H
            Setting  this  variable to a non-zero value will cause qqmmaaiill--ssmmttppdd
            to not accept the MAIL FROM command until the  user  has  success‐
            fully  authenticated  (using the AUTH command.) Note that this may
            be combined with FFOORRCCEE__TTLLSS to create a secure  server  which  your
            users can use to relay mail.

            If  you try to set this without properly specifying an authentica‐
            tion program on the command line, the client will receive an error
            message  and  qqmmaaiill--ssmmttppdd  will exit without accepting any message
            from the client.

       _S_M_T_P___A_U_T_H___U_S_E_R
            When the remote SMTP client sends a successful AUTH  command,  the
            SSMMTTPP__AAUUTTHH__UUSSEERR variable will be set to the userid from the creden‐
            tials. This variable can be tested by any scripts  called  through
            the  QQMMAAIILLQQUUEEUUEE  mechanism  to determine whether or not the remote
            SMTP client has sent a successful AUTH command or not.

       _Q_M_A_I_L_S_M_T_P_D___H_E_L_P___V_E_R_S_I_O_N
            If this variable is set to a non-zero value,  the  output  of  the
            HELP command will include the version and URL of the jms1 combined
            patch you are using.

            Note that this variable is re-checked after a successful AUTH com‐
            mand,  which  makes  it  possible  to  change  its  value using an
            AUTH_SET_QMAILSMTPD_HELP_VERSION environment variable.

       _Q_M_A_I_L_S_M_T_P_D___L_O_G___M_A_I_L
            If this variable is set to a non-zero value, qmail-smtpd will  log
            the  sender  addresses  specified in all successful MAIL FROM com‐
            mands received from the client.

       _Q_M_A_I_L_S_M_T_P_D___L_O_G___R_C_P_T
            If this variable is set to a non-zero value, qmail-smtpd will  log
            the  recipient  addresses specified in all successful RCPT TO com‐
            mands received from the client.

       _S_M_T_P_G_R_E_E_T_I_N_G
            This variable overrides the value stored in the ssmmttppggrreeeettiinngg  con‐
            trol file (see above.)

       _S_P_F_B_E_H_A_V_I_O_R
            This  variable  overrides the value stored in the ssppffbbeehhaavviioorr con‐
            trol file (see above.)

            Note that this variable is re-checked after a successful AUTH com‐
            mand,  which  makes  it  possible  to  change  its  value using an
            AUTH_SET_SPFBEHAVIOR environment variable.

       _S_P_F___B_L_O_C_K___P_L_U_S___A_L_L
            Setting this variable to a non-zero value will  cause  any  "+all"
            term  found  in  a  domain’s SPF record to be interpreted as if it
            said "-all". This can be useful if you have a problem  with  spam‐
            mers  who  have  discovered  that  by  creating an SPF record with
            "+all" in it, they can basically "walk around" any SPF-based  fil‐
            tering you may be doing.

            This variable is checked during the SPF check, which happens after
            the client sends a MAIL FROM command. This makes  it  possible  to
            change  its value using an AUTH_SET_SPF_BLOCK_PLUS_ALL environment
            variable.

       _S_P_F___L_O_G
            Setting this variable to a non-zero value will cause the result of
            every SPF check to be logged. The log entries will be identical to
            the "Received-SPF" header which is added to each incoming message.

            This variable is re-checked after a successful AUTH command, which
            makes it possible to change its value  using  an  AUTH_SET_SPF_LOG
            environment variable.

       _S_S_L  This  variable  should be set to a non-zero value if the SMTP ser‐
            vice is running qqmmaaiill--ssmmttppdd  under  an  SSL-secured  socket.  This
            tells qqmmaaiill--ssmmttppdd that the connection is secure, which enables the
            AUTH command and disables the STARTTLS command.

       _T_C_P_R_E_M_O_T_E_I_N_F_O
            This variable is normally set by ttccppsseerrvveerr if run without  the  -R
            option,  and will contain the data (if any) returned by the iiddeennttdd
            service on the remote SMTP client’s IP address. A successful  AUTH
            command  will  add or replace this value with the userid which was
            part of the credentials. The data is the same as  what  you  would
            find  in the SSMMTTPP__AAUUTTHH__UUSSEERR variable, with the exception that this
            variable may exist without a successful AUTH command.

       _T_L_S___S_E_R_V_E_R___C_E_R_T
            This variable contains the name of a file, which contains  a  PEM-
            encoded private key and certificate used to encrypt the connection
            if a STARTTLS  command  is  received.  If  this  variable  is  not
            present, the default name ccoonnttrrooll//sseerrvveerrcceerrtt..ppeemm will be used.

            Note  that  if  you wish to set up a service which will not accept
            the STARTTLS command at all, you may either remove  whatever  file
            this  variable (or the default value) points to, or you can create
            a DDEENNYY__TTLLSS environment variable with a non-zero value.

       _V_A_L_I_D_R_C_P_T_T_O___C_D_B
            If this variable is present and not empty, qmail-smtpd will expect
            it  to  contain the name of a cdb file. qmail-smtpd will check the
            argument of every RCPT command against this file. It searches  the
            file  for  a  key  which matches the RCPT command. If a key is not
            found, the RCPT command will be rejected.  If a key is found,  the
            RCPT  command  may be accepted or rejected, depending on the value
            (if any) attached to that key.

            qmail-smtpd searches first for a key which matches the argument to
            the  RCPT command. If the address sent by the client is not found,
            and if the mailbox portion of the address (the part to the left of
            the  "@"  sign)  contains  one  or more of qmail’s "ext" character
            (usually "-", ASCII 45) it will search for any appropriate entries
            of  the form uusseerr--ddeeffaauulltt@@ddoommaaiinn going from more to less specific,
            with @@ddoommaaiinn as a final resort.

            For example, if the address sent is uusseerr--oonnee--ttwwoo--tthhrreeee@@ddoommaaiinn,,  it
            will search for the following items:

               user-one-two-three@domain
               user-one-two-default@domain
               user-one-default@domain
               user-default@domain
               @domain

            The first key key it finds while searching is what will be used.

            Once  an  appropriate key is found, the value (if any) attached to
            that key is checked. If the key has no value (as will be the  case
            if  you  are  using an older version of the validrcptto.cdb patch)
            then the address will be accepted. If there is a  value  attached,
            and  if  the first byte of that value is a hyphen (i.e. "-", ASCII
            45) then the address will be rejected.  Values other than "-"  are
            reserved for future versions of this patch and should not be used.

            In order to prevent "harvesting" attacks, qqmmaaiill--ssmmttppdd  counts  how
            many  invalid  recipients  have been attempted in each connection,
            and when a certain limit is  reached,  qqmmaaiill--ssmmttppdd  will  forcibly
            disconnect  the  client.  This  limit has a default 10, and can be
            changed or disabled with the VVAALLIIDDRRCCPPTTTTOO__LLIIMMIITT  environment  vari‐
            able.

            This variable is re-checked after a successful AUTH command, which
            makes it possible to change its value  using  an  AUTH_SET_VALIDR‐
            CPTTO_CDB or AUTH_UNSET_VALIDRCPTTO_CDB environment variable.

       _V_A_L_I_D_R_C_P_T_T_O___L_I_M_I_T
            This  variable sets the limit of how many invalid RCPT TO commands
            will be treated as "soft errors".  When  this  limit  is  reached,
            qqmmaaiill--ssmmttppdd  will forcibly disconnect from the client. The default
            limit is 10. Setting this value to zero will disable the  counting
            entirely,  making it possible for a spammer to "harvest" the valid
            email addresses on your server.

            This variable is re-checked after a successful AUTH command, which
            makes  it  possible  to change its value using an AUTH_SET_VALIDR‐
            CPTTO_LIMIT environment variable.

       _V_A_L_I_D_R_C_P_T_T_O___L_O_G
            Setting this variable to 1 will cause qqmmaaiill--ssmmttppdd to log each RCPT
            TO  command received from a client, along with what entry from the
            vvaalliiddrrccppttttoo..ccddbb control file matched the address  entered.  If  no
            match  was  found,  that  will  be  logged as well. If a client is
            forcibly  disconnected  for  trying  more  than  VVAALLIIDDRRCCPPTTTTOO__LLIIMMIITT
            invalid recipients, that will be logged as well.

            Setting  this  variable  to  2  will cause qqmmaaiill--ssmmttppdd to also log
            everything it searches for within the vvaalliiddrrccppttttoo..ccddbb  file.  This
            can be useful when debugging a problem.

            This variable is re-checked after a successful AUTH command, which
            makes   it   possible   to   change    its    value    using    an
            AUTH_SET_VALIDRCPTTO_LOG environment variable.

SSEEEE AALLSSOO
       tcp-env(1),  tcp-environ(5),  qmail-control(5), qmail-inject(8), qmail-
       newmrh(8), qmail-queue(8), qmail-remote(8)

HHIISSTTOORRYY
       See   hhttttpp::////qqmmaaiill..jjmmss11..nneett//ppaattcchheess//ccoommbbiinneedd--ddeettaaiillss..sshhttmmll   for   more
       detailed  information  about  the  differences between this instance of
       qmail and the stock qmail. This man page is current as of the 77..0088 ver‐
       sion of the combined patch file.



                                                                qmail-smtpd(8)
